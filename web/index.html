<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prise de rendez-vous – OptiGenius</title>
  <style>
    :root { --gap:12px; --fg:#1f2937; --ok:#065f46; --err:#7f1d1d; --muted:#6b7280; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--fg); margin:0; padding:24px; background:#f9fafb; }
    .container { max-width: 720px; margin:0 auto; background:#fff; border-radius:16px; padding:24px; box-shadow:0 10px 25px rgba(0,0,0,.06); }
    h1 { margin:0 0 10px; font-size:1.5rem; }
    form { display:grid; gap:var(--gap); }
    .row { display:grid; gap:6px; }
    label { font-weight:600; }
    input, textarea, button { font:inherit; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
    input:focus, textarea:focus { outline:3px solid #bfdbfe; border-color:#93c5fd; }
    .help { color:var(--muted); font-size:.9rem }
    .actions { display:flex; gap:10px; align-items:center; }
    button { cursor:pointer; border:none; background:#111827; color:#fff; }
    button[disabled] { opacity:.6; cursor:progress; }
    .status { margin-top:10px; }
    .ok  { background:#ecfdf5; border:1px solid #a7f3d0; color:var(--ok);  padding:10px; border-radius:10px; }
    .err { background:#fef2f2; border:1px solid #fecaca; color:var(--err); padding:10px; border-radius:10px; }
    pre { background:#0b1020; color:#e5e7eb; padding:12px; border-radius:10px; overflow:auto; }
  </style>
</head>
<body>
  <main class="container">
    <h1>Prendre un rendez-vous</h1>
    <p class="help">Remplis le formulaire puis envoie. Le serveur répondra avec un statut si l’enregistrement est ok.</p>

    <form id="appt-form" novalidate>
      <div class="row">
        <label for="name">Nom</label>
        <input id="name" name="name" autocomplete="name" required />
      </div>
      <div class="row">
        <label for="phone">Téléphone</label>
        <input id="phone" name="phone" type="tel" inputmode="tel" autocomplete="tel" required />
      </div>
      <div class="row">
        <label for="dt">Date & heure</label>
        <input id="dt" name="datetime" type="datetime-local" required />
        <div class="help">Format: AAAA-MM-JJ HH:MM (heure locale)</div>
      </div>
      <div class="row">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" rows="3" spellcheck="true"></textarea>
      </div>

      <div class="actions">
        <button id="submitBtn" type="submit">Envoyer</button>
        <button id="pingBtn" type="button" title="Tester la connexion">Tester la connexion</button>
      </div>

      <div id="statusWrap" class="status" aria-live="polite">
        <p id="statusOk"  class="ok"  hidden>Rendez-vous enregistré ✔</p>
        <p id="statusErr" class="err" hidden></p>
      </div>

      <h2>Réponse brute</h2>
      <pre id="lastResp" aria-live="polite"></pre>
    </form>
  </main>

  <script>
    const form = document.getElementById('appt-form');
    const btn  = document.getElementById('submitBtn');
    const okEl = document.getElementById('statusOk');
    const errEl= document.getElementById('statusErr');
    const last = document.getElementById('lastResp');
    const ping = document.getElementById('pingBtn');

    function showOk(msg)  { okEl.textContent = msg || 'Rendez-vous enregistré ✔'; okEl.hidden=false; errEl.hidden=true; }
    function showErr(msg) { errEl.textContent= msg || 'Erreur'; errEl.hidden=false; okEl.hidden=true; }
    function clearStatus(){ okEl.hidden=true; errEl.hidden=true; last.textContent=''; }

    // Conserve l’heure entrée telle quelle en ISO simplifié
    function toIsoZ(dtLocal) {
      if (!dtLocal) return '';
      return dtLocal.length === 16 ? dtLocal + ':00Z' : dtLocal + 'Z'; // "YYYY-MM-DDTHH:MM(:SS)Z"
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearStatus();
      btn.disabled = true;

      const data = {
        name: form.name.value.trim(),
        phone: form.phone.value.trim(),
        datetime: toIsoZ(form.datetime.value),
        notes: form.notes.value.trim() || null
      };

      if (!data.name || !data.phone || !form.datetime.value) {
        showErr('Veuillez remplir tous les champs obligatoires.');
        btn.disabled = false;
        return;
      }

      try {
        const r = await fetch('/appointments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const txt = await r.text();
        last.textContent = txt;

        if (r.ok) {
          showOk('Rendez-vous enregistré ✔');
          form.reset();
        } else {
          showErr('Erreur côté serveur (' + r.status + ').');
        }
      } catch (err) {
        showErr('Impossible de contacter le serveur.');
      } finally {
        btn.disabled = false;
      }
    });

    ping.addEventListener('click', async () => {
      clearStatus();
      try {
        const r = await fetch('/health', { method: 'GET' });
        if (r.ok) showOk('Connexion OK au /health');
        else showErr('Health check HTTP ' + r.status);
      } catch {
        showErr('Health check indisponible.');
      }
    });
  </script>
</body>
</html>
